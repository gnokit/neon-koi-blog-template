---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Search" description="Search blog posts">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-4xl font-bold text-neutral-900 dark:text-white mb-8">Search</h1>

    <div class="relative mb-8">
      <input
        type="text"
        id="search-input"
        placeholder="Search posts..."
        class="w-full px-4 py-3 pl-12 bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-lg text-neutral-900 dark:text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
      />
      <svg
        class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-neutral-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        />
      </svg>
    </div>

    <div id="search-stats" class="text-sm text-neutral-600 dark:text-neutral-400 mb-6 hidden">
      <span id="result-count">0</span> results found
    </div>

    <div id="search-results" class="space-y-6">
      <!-- Results will be populated by JavaScript -->
    </div>

    <div id="no-results" class="text-center py-12 hidden">
      <p class="text-neutral-600 dark:text-neutral-400">No posts found matching your search.</p>
    </div>

    <div id="initial-state" class="text-center py-12">
      <p class="text-neutral-500 dark:text-neutral-500">Start typing to search posts...</p>
    </div>
  </div>
</BaseLayout>

<script>
  import Fuse from 'fuse.js';

  interface SearchPost {
    slug: string;
    title: string;
    description: string;
    pubDate: string;
    author: string;
    tags: string[];
    thumbnail: string;
  }

  let fuse: Fuse<SearchPost>;
  let posts: SearchPost[] = [];

  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchResults = document.getElementById('search-results') as HTMLDivElement;
  const searchStats = document.getElementById('search-stats') as HTMLDivElement;
  const resultCount = document.getElementById('result-count') as HTMLSpanElement;
  const noResults = document.getElementById('no-results') as HTMLDivElement;
  const initialState = document.getElementById('initial-state') as HTMLDivElement;

  // Fetch search data
  async function initSearch() {
    try {
      const response = await fetch('/search.json');
      posts = await response.json();

      fuse = new Fuse(posts, {
        keys: [
          { name: 'title', weight: 0.4 },
          { name: 'description', weight: 0.3 },
          { name: 'tags', weight: 0.2 },
          { name: 'author', weight: 0.1 },
        ],
        threshold: 0.3,
        includeScore: true,
      });
    } catch (error) {
      console.error('Failed to load search data:', error);
    }
  }

  function formatDate(dateString: string): string {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  }

  function renderResults(results: Fuse.FuseResult<SearchPost>[]) {
    searchResults.innerHTML = '';

    if (results.length === 0) {
      searchResults.classList.add('hidden');
      searchStats.classList.add('hidden');
      noResults.classList.remove('hidden');
      return;
    }

    searchResults.classList.remove('hidden');
    searchStats.classList.remove('hidden');
    noResults.classList.add('hidden');
    resultCount.textContent = results.length.toString();

    results.forEach(({ item }) => {
      const article = document.createElement('article');
      article.className = 'flex gap-4 p-4 bg-neutral-50 dark:bg-neutral-800/50 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors';

      article.innerHTML = `
        <img
          src="${item.thumbnail}"
          alt="${item.title}"
          class="w-24 h-24 object-cover rounded-lg flex-shrink-0"
        />
        <div class="flex-1 min-w-0">
          <h2 class="text-lg font-semibold text-neutral-900 dark:text-white mb-1">
            <a href="/blog/${item.slug}/" class="hover:text-purple-600 dark:hover:text-purple-400 transition-colors">
              ${item.title}
            </a>
          </h2>
          <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-2 line-clamp-2">
            ${item.description}
          </p>
          <div class="flex items-center gap-4 text-xs text-neutral-500 dark:text-neutral-500">
            <span>${formatDate(item.pubDate)}</span>
            <span>by ${item.author}</span>
          </div>
          ${item.tags.length > 0 ? `
            <div class="flex flex-wrap gap-2 mt-2">
              ${item.tags.map(tag => `
                <span class="px-2 py-1 text-xs bg-neutral-200 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 rounded">
                  ${tag}
                </span>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;

      searchResults.appendChild(article);
    });
  }

  function handleSearch() {
    const query = searchInput.value.trim();

    if (query.length === 0) {
      initialState.classList.remove('hidden');
      searchResults.classList.add('hidden');
      searchStats.classList.add('hidden');
      noResults.classList.add('hidden');
      return;
    }

    initialState.classList.add('hidden');

    if (!fuse) {
      return;
    }

    const results = fuse.search(query);
    renderResults(results);
  }

  // Initialize
  initSearch();

  // Event listeners
  searchInput.addEventListener('input', handleSearch);

  // Focus input on page load
  searchInput.focus();
</script>
